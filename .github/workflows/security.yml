# GitHub Actions Workflow: Security Checks
#
# Este workflow valida seguridad del proyecto con:
# - Tests de seguridad (33 tests: auth, JWT, rate limiting, prompt injection)
# - Validación de configuración de producción
# - Dependency audit (pip-audit para vulnerabilidades conocidas)
#
# Coverage objetivo: ≥90% en módulos de seguridad críticos
#
# Triggers:
# - Push a main, develop
# - Pull requests a main
# - Schedule: Lunes 2am UTC (audit semanal)

name: Security Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Ejecutar semanalmente (lunes 2am UTC)
    - cron: '0 2 * * 1'

jobs:
  security-tests:
    name: Security Test Suite
    runs-on: ubuntu-latest

    # Service containers: Postgres + Redis (necesarios para tests)
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    # Variables de entorno para tests
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
      REDIS_URL: redis://localhost:6379/0
      ENVIRONMENT: test
      DEBUG: false
      JWT_SECRET_KEY: test-secret-key-for-ci-only-do-not-use-in-production
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

    steps:
      # 1. Checkout del código
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Python 3.11
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Cache de Poetry virtualenv
      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-security-${{ hashFiles('poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-security-

      # 4. Instalar Poetry
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # 5. Instalar dependencias
      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi

      # 6. Ejecutar migraciones
      - name: Run database migrations
        run: |
          poetry run alembic upgrade head

      # 7. Ejecutar tests de seguridad
      - name: Run security tests
        run: |
          poetry run pytest tests/security/ \
            --cov=src/api/auth \
            --cov=src/services/input_sanitizer \
            --cov=src/services/output_validator \
            --cov-report=term-missing \
            --cov-report=xml \
            -v

      # 8. Validar coverage de seguridad (≥90%)
      - name: Check security coverage threshold
        run: |
          poetry run coverage report \
            --include="src/api/auth/*,src/services/input_sanitizer.py,src/services/output_validator.py" \
            --fail-under=90

      # 9. Validar configuración de producción
      - name: Validate production config safety
        if: github.ref == 'refs/heads/main'
        run: |
          python -c "
          import os
          import sys

          # Simular intento de configuración insegura
          os.environ['ENVIRONMENT'] = 'production'
          os.environ['DEBUG'] = 'true'  # Intencional: debe fallar

          try:
              from src.core.config import Settings
              settings = Settings()

              # Validaciones
              if settings.DEBUG:
                  print('❌ ERROR: DEBUG must be False in production')
                  sys.exit(1)

              if settings.ENVIRONMENT != 'production':
                  print('❌ ERROR: ENVIRONMENT must be production')
                  sys.exit(1)

              print('✅ Production config validation passed')
          except Exception as e:
              print(f'✅ Config validation working correctly: {e}')
              # Esperamos que falle con DEBUG=true en producción
          "

      # 10. Instalar pip-audit
      - name: Install pip-audit
        run: |
          pip install pip-audit

      # 11. Audit de dependencias
      - name: Audit dependencies for vulnerabilities
        run: |
          poetry export -f requirements.txt --without-hashes | \
          pip-audit --requirement /dev/stdin --format json --output audit-report.json
        continue-on-error: true

      # 12. Verificar vulnerabilidades críticas
      - name: Check for critical vulnerabilities
        run: |
          python -c "
          import json
          import sys

          try:
              with open('audit-report.json') as f:
                  report = json.load(f)

              # Extraer vulnerabilidades críticas
              vulns = report.get('vulnerabilities', [])
              critical = [v for v in vulns
                          if v.get('aliases', [{}])[0].get('severity', '') in ['HIGH', 'CRITICAL']]

              if critical:
                  print(f'❌ Found {len(critical)} critical vulnerabilities:')
                  for v in critical:
                      pkg = v.get('package', 'unknown')
                      vuln_id = v.get('id', 'unknown')
                      severity = v.get('aliases', [{}])[0].get('severity', 'UNKNOWN')
                      print(f'  - {pkg}: {vuln_id} ({severity})')
                  sys.exit(1)
              else:
                  print('✅ No critical vulnerabilities found')
          except FileNotFoundError:
              print('⚠️  No audit report generated (no vulnerabilities or pip-audit failed)')
          except json.JSONDecodeError:
              print('⚠️  Audit report is empty or invalid')
          "

      # 13. Upload audit report
      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-report
          path: audit-report.json
